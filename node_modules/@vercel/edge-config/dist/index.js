import{readFile as A}from"@vercel/edge-config-fs";var i={UNEXPECTED:"@vercel/edge-config: Unexpected error",UNAUTHORIZED:"@vercel/edge-config: Unauthorized",NETWORK:"@vercel/edge-config: Network error",EDGE_CONFIG_NOT_FOUND:"@vercel/edge-config: Edge Config not found"};function C(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function O(e,t){let a={};return t.forEach(c=>{a[c]=e[c]}),a}function u(e){if(typeof e!="string")throw new Error("@vercel/edge-config: Expected key to be a string")}function m(e){if(!Array.isArray(e)||e.some(t=>typeof t!="string"))throw new Error("@vercel/edge-config: Expected keys to be an array of string")}function E(e){return typeof structuredClone=="function"?structuredClone(e):e===void 0?e:JSON.parse(JSON.stringify(e))}function P(e){try{let t=new URL(e);if(t.host!=="edge-config.vercel.com"||t.protocol!=="https:"||!t.pathname.startsWith("/ecfg"))return null;let a=t.pathname.split("/")[1];if(!a)return null;let c=t.searchParams.get("token");return!c||c===""?null:{id:a,token:c}}catch{return null}}var h=e=>e instanceof Error&&C(e,"digest")&&e.digest==="DYNAMIC_SERVER_USAGE";var y=new Map;async function p(e,t={}){let{headers:a=new Headers,...c}=t,g=a.get("Authorization"),r=`${e},${g||""}`,o=y.get(r);if(o){let{etag:v,response:x}=o,R=new Headers(a);R.set("If-None-Match",v);let d=await fetch(e,{...c,headers:R});if(d.status===304)return d.cachedResponseBody=JSON.parse(x),d;let N=d.headers.get("ETag");return d.ok&&N&&y.set(r,{etag:N,response:await d.clone().text()}),d}let n=await fetch(e,t),s=n.headers.get("ETag");return n.ok&&s&&y.set(r,{etag:s,response:await n.clone().text()}),n}async function l(e){if(!process.env.AWS_LAMBDA_FUNCTION_NAME)return null;try{let t=await A(`/opt/edge-config/${e.id}.json`,"utf-8");return JSON.parse(t)}catch{return null}}async function T(e){typeof EdgeRuntime=="undefined"&&await e.arrayBuffer()}function D(e){if(!e)throw new Error("@vercel/edge-config: No connection string provided");let t=P(e);if(!t)throw new Error("@vercel/edge-config: Invalid connection string provided");let a=`https://edge-config.vercel.com/${t.id}`,c="1",g={Authorization:`Bearer ${t.token}`};return{async get(r){let o=await l(t);return o?(u(r),Promise.resolve(E(o.items[r]))):(u(r),p(`${a}/item/${r}?version=${c}`,{headers:new Headers(g),cache:"no-store"}).then(async n=>{if(n.ok)return n.json();if(await T(n),n.status===401)throw new Error(i.UNAUTHORIZED);if(n.status===404){if(n.headers.has("x-edge-config-digest"))return;throw new Error(i.EDGE_CONFIG_NOT_FOUND)}if(n.cachedResponseBody!==void 0)return n.cachedResponseBody;throw new Error(i.UNEXPECTED)},n=>{throw h(n)?n:new Error(i.NETWORK)}))},async has(r){let o=await l(t);return o?(u(r),Promise.resolve(C(o.items,r))):(u(r),fetch(`${a}/item/${r}?version=${c}`,{method:"HEAD",headers:new Headers(g),cache:"no-store"}).then(n=>{if(n.status===401)throw new Error(i.UNAUTHORIZED);if(n.status===404){if(n.headers.has("x-edge-config-digest"))return!1;throw new Error(i.EDGE_CONFIG_NOT_FOUND)}if(n.ok)return!0;throw new Error(i.UNEXPECTED)},n=>{throw h(n)?n:new Error(i.NETWORK)}))},async getAll(r){let o=await l(t);if(o)return r===void 0?Promise.resolve(E(o.items)):(m(r),Promise.resolve(E(O(o.items,r))));Array.isArray(r)&&m(r);let n=Array.isArray(r)?new URLSearchParams(r.map(s=>["key",s])).toString():null;return n===""?Promise.resolve({}):p(`${a}/items?version=${c}${n===null?"":`&${n}`}`,{headers:new Headers(g),cache:"no-store"}).then(async s=>{if(s.ok)return s.json();if(await T(s),s.status===401)throw new Error(i.UNAUTHORIZED);if(s.status===404)throw new Error(i.EDGE_CONFIG_NOT_FOUND);if(s.cachedResponseBody!==void 0)return s.cachedResponseBody;throw new Error(i.UNEXPECTED)},s=>{throw h(s)?s:new Error(i.NETWORK)})},async digest(){let r=await l(t);return r?Promise.resolve(r.digest):p(`${a}/digest?version=1`,{headers:new Headers(g),cache:"no-store"}).then(async o=>{if(o.ok)return o.json();if(await T(o),o.cachedResponseBody!==void 0)return o.cachedResponseBody;throw new Error(i.UNEXPECTED)},o=>{throw h(o)?o:new Error(i.NETWORK)})}}}var f;function w(){f||(f=D(process.env.EDGE_CONFIG))}var S=(...e)=>(w(),f.get(...e)),k=(...e)=>(w(),f.getAll(...e)),F=(...e)=>(w(),f.has(...e)),H=(...e)=>(w(),f.digest(...e));export{D as createClient,H as digest,S as get,k as getAll,F as has,P as parseConnectionString};
